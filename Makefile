.PHONY: all debug release clean

ifeq ($(WITHOUT_RUNTIME_FLAG),true)
WITHOUT_RUNTIME_SUFFIX=-Rt
else
WITHOUT_RUNTIME_SUFFIX=+Rt
endif

FILE_SUFFIX_BASE=_$(GCC_VER)_$(FBC_VER)_$(WITHOUT_RUNTIME_SUFFIX)
FILE_SUFFIX=$(FILE_SUFFIX_BASE)

OUTPUT_FILE_NAME=Station922$(FILE_SUFFIX).exe

# Object files

OBJECTFILES_RELEASE_OBJECTS_COM=$(OBJ_RELEASE_DIR)$(PATH_SEP)AcceptConnectionAsyncTask$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ArrayStringWriter$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)AsyncResult$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ClientRequest$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ClientUri$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)CreateInstance$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)FileBuffer$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HeapBSTR$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HeapMemoryAllocator$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpGetProcessor$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpOptionsProcessor$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpProcessorCollection$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpReader$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpTraceProcessor$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpWriter$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)IniConfiguration$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)MemoryBuffer$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)NetworkStream$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ReadRequestAsyncTask$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ServerResponse$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)TcpListener$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)ThreadPool$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WebServer$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WebSite$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WebSiteCollection$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WriteErrorAsyncTask$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WriteResponseAsyncTask$(FILE_SUFFIX).$(O_EXT) 
OBJECTFILES_DEBUG_OBJECTS_COM=  $(OBJ_DEBUG_DIR)$(PATH_SEP)AcceptConnectionAsyncTask$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ArrayStringWriter$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)AsyncResult$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientRequest$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientUri$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)CreateInstance$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)FileBuffer$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HeapBSTR$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HeapMemoryAllocator$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpGetProcessor$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpOptionsProcessor$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpProcessorCollection$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpReader$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpTraceProcessor$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpWriter$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)IniConfiguration$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)MemoryBuffer$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)NetworkStream$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ReadRequestAsyncTask$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ServerResponse$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)TcpListener$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ThreadPool$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebServer$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebSite$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebSiteCollection$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WriteErrorAsyncTask$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WriteResponseAsyncTask$(FILE_SUFFIX).$(O_EXT)   

OBJECTFILES_RELEASE_MODULES=$(OBJ_RELEASE_DIR)$(PATH_SEP)ClientBuffer$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Station922$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Http$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Logger$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Mime$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)Network$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WebUtils$(FILE_SUFFIX).$(O_EXT) 
OBJECTFILES_DEBUG_MODULES=  $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientBuffer$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Station922$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Http$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Logger$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Mime$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)Network$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebUtils$(FILE_SUFFIX).$(O_EXT)   

OBJECTFILES_RELEASE_RESOURCES=$(OBJ_RELEASE_DIR)$(PATH_SEP)Resources$(FILE_SUFFIX).$(OBJ_EXT)
OBJECTFILES_DEBUG_RESOURCES=  $(OBJ_DEBUG_DIR)$(PATH_SEP)Resources$(FILE_SUFFIX).$(OBJ_EXT)

OBJECTFILES_RELEASE_BASE=$(OBJECTFILES_RELEASE_OBJECTS_COM) $(OBJECTFILES_RELEASE_MODULES) $(OBJECTFILES_RELEASE_RESOURCES)
OBJECTFILES_DEBUG_BASE=  $(OBJECTFILES_DEBUG_OBJECTS_COM)   $(OBJECTFILES_DEBUG_MODULES)   $(OBJECTFILES_DEBUG_RESOURCES)

OBJECTFILES_RELEASE=$(OBJECTFILES_RELEASE_BASE) $(OBJ_RELEASE_DIR)$(PATH_SEP)ConsoleMain$(FILE_SUFFIX).$(O_EXT) $(OBJ_RELEASE_DIR)$(PATH_SEP)WindowsServiceMain$(FILE_SUFFIX).$(O_EXT)
OBJECTFILES_DEBUG=  $(OBJECTFILES_DEBUG_BASE)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ConsoleMain$(FILE_SUFFIX).$(O_EXT)   $(OBJ_DEBUG_DIR)$(PATH_SEP)WindowsServiceMain$(FILE_SUFFIX).$(O_EXT)  

ifeq ($(CODE_EMITTER),gcc)
FBCFLAGS+=-gen gcc
else
FBCFLAGS+=-gen gcc
endif

ifeq ($(PROCESSOR_ARCHITECTURE),AMD64)
CFLAGS+=-m64
ASFLAGS+=--64
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
ENTRY_POINT_PARAM=-e ENTRYPOINT
else
ENTRY_POINT_PARAM=
endif
LDFLAGS+=-m i386pep
GORCFLAGS+=/machine X64
else
CFLAGS+=-m32
ASFLAGS+=--32
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
ENTRY_POINT_PARAM=-e _ENTRYPOINT@0
else
ENTRY_POINT_PARAM=
endif
LDFLAGS+=-m i386pe --large-address-aware
GORCFLAGS+=
endif

MOVE_COMMAND ?= cmd.exe /c move /y
DELETE_COMMAND ?= cmd.exe /c del /f /q

FBC ?= fbc.exe
FBCFLAGS+=-d UNICODE -w error -maxerr 1 -i src -r -s console -O 0
FBCFLAGS_DEBUG+=-g
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
FBCFLAGS+=-d WITHOUT_RUNTIME
endif

CC ?= gcc.exe
C_EXT ?= c
EXTRA_CFLAGS+=-S
MARCH ?= native
CFLAGS+=-march=$(MARCH)
CFLAGS+=-nostdlib -nostdinc -Wall -Werror -Wno-main
CFLAGS+=-Wno-unused-label -Wno-unused-function -Wno-unused-variable
CFLAGS+=-Werror-implicit-function-declaration
CFLAGS_DEBUG+=-g -O0

AS ?= as.exe
ASM_EXT ?= asm
O_EXT ?= o
ASFLAGS+=
ASFLAGS_DEBUG+=

AR ?= ar.exe

GORC ?= GoRC.exe
OBJ_EXT ?= obj
GORCFLAGS+=/ni /o /d FROM_MAKEFILE
GORCFLAGS_DEBUG=/d DEBUG

LD ?= ld.exe
LDFLAGS+=--major-image-version 1 --minor-image-version 0
LDFLAGS+=-subsystem console
LDFLAGS+=--stack 1048576,1048576 --no-seh --nxcompat
LDFLAGS+=$(ENTRY_POINT_PARAM)
LDFLAGS+=-L $(LIB_DIR) -T "src$(PATH_SEP)fbextra.x"
LDLIBS+=-ladvapi32 -lkernel32 -lmsvcrt -lmswsock -lole32 -loleaut32
LDLIBS+=-lshell32 -lshlwapi -luuid -lws2_32
LDLIBS_DEBUG+=-lgcc -lmingw32 -lmingwex -lmoldname -lgcc_eh
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
else
LDLIBS+=crt2.o crtbegin.o crtend.o fbrt0.o gcrt2.o -lfbmt
endif


all: release debug

release: CFLAGS+=$(CFLAGS_RELEASE) -fstrict-aliasing -frounding-math
release: CFLAGS+=-fno-math-errno -fno-exceptions -fomit-frame-pointer
release: CFLAGS+=-mno-stack-arg-probe -fno-stack-check -fno-stack-protector
release: CFLAGS+=-fno-unwind-tables -fno-asynchronous-unwind-tables
release: CFLAGS+=-Ofast -fno-ident -fdata-sections -ffunction-sections
release: ASFLAGS+=--strip-local-absolute
release: LDFLAGS+=-s --gc-sections
release: $(BIN_RELEASE_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME)

debug: FBCFLAGS+=$(FBCFLAGS_DEBUG)
debug: CFLAGS+=$(CFLAGS_DEBUG)
debug: ASFLAGS+=$(ASFLAGS_DEBUG)
debug: GORCFLAGS+=$(GORCFLAGS_DEBUG)
debug: LDFLAGS+=$(LDFLAGS_DEBUG)
debug: LDLIBS+=$(LDLIBS_DEBUG)
debug: $(BIN_DEBUG_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME)

.PRECIOUS: $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT)
.PRECIOUS: $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT)
.PRECIOUS: $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT)
.PRECIOUS: $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT)

clean:
	$(DELETE_COMMAND) $(OBJ_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)*.$(C_EXT)
	$(DELETE_COMMAND) $(OBJ_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)*.$(C_EXT)
	$(DELETE_COMMAND) $(OBJ_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)*.$(ASM_EXT)
	$(DELETE_COMMAND) $(OBJ_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)*.$(ASM_EXT)
	$(DELETE_COMMAND) $(OBJ_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)*.$(O_EXT)
	$(DELETE_COMMAND) $(OBJ_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)*.$(O_EXT)
	$(DELETE_COMMAND) $(OBJ_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)*.$(OBJ_EXT)
	$(DELETE_COMMAND) $(OBJ_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)*.$(OBJ_EXT)
	$(DELETE_COMMAND) $(BIN_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)$(OUTPUT_FILE_NAME)
	$(DELETE_COMMAND) $(BIN_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)$(OUTPUT_FILE_NAME)

include dependencies.mk

$(BIN_RELEASE_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME): $(OBJECTFILES_RELEASE)
	$(LD) $(LDFLAGS) $^ $(LDLIBS) -o $@

$(BIN_DEBUG_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME):   $(OBJECTFILES_DEBUG)
	$(LD) $(LDFLAGS) $^ $(LDLIBS) -o $@

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(O_EXT): $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT)
	$(AS) $(ASFLAGS) -o $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(O_EXT): $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT)
	$(AS) $(ASFLAGS) -o $@ $<

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT): $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT)
	$(CC) $(EXTRA_CFLAGS) $(CFLAGS) -o $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(ASM_EXT): $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT)
	$(CC) $(EXTRA_CFLAGS) $(CFLAGS) -o $@ $<

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT): src$(PATH_SEP)%.bas
	$(FBC) $(FBCFLAGS) $<
	$(MOVE_COMMAND) src$(MOVE_PATH_SEP)$*.$(C_EXT) $(OBJ_RELEASE_DIR_MOVE)$(MOVE_PATH_SEP)$*$(FILE_SUFFIX).$(C_EXT)

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(C_EXT): src$(PATH_SEP)%.bas
	$(FBC) $(FBCFLAGS) $<
	$(MOVE_COMMAND) src$(MOVE_PATH_SEP)$*.$(C_EXT) $(OBJ_DEBUG_DIR_MOVE)$(MOVE_PATH_SEP)$*$(FILE_SUFFIX).$(C_EXT)

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(OBJ_EXT): src$(PATH_SEP)%.RC
	$(GORC) $(GORCFLAGS) /fo $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX).$(OBJ_EXT): src$(PATH_SEP)%.RC
	$(GORC) $(GORCFLAGS) /fo $@ $<
