.PHONY: all debug release clean

ifeq ($(WITHOUT_RUNTIME_FLAG),true)
FBCFLAGS+=-d WITHOUT_RUNTIME
FBCFLAGS_DEBUG+=-d WITHOUT_RUNTIME
WITHOUT_RUNTIME_SUFFIX=-Rt
else
WITHOUT_RUNTIME_SUFFIX=+Rt
LDLIBS+=crt2.o crtbegin.o crtend.o fbrt0.o gcrt2.o -lfbmt
endif

FILE_SUFFIX_BASE=_$(GCC_VER)_$(FBC_VER)_$(WITHOUT_RUNTIME_SUFFIX)
FILE_SUFFIX_CONSOLE=$(FILE_SUFFIX_BASE)

CODE_GENERATION_BACKEND=gcc

BIN_DEBUG_DIR_64=bin$(PATH_SEP)Debug$(PATH_SEP)x64
BIN_RELEASE_DIR_64=bin$(PATH_SEP)Release$(PATH_SEP)x64
OBJ_DEBUG_DIR_64=obj$(PATH_SEP)Debug$(PATH_SEP)x64
OBJ_RELEASE_DIR_64=obj$(PATH_SEP)Release$(PATH_SEP)x64

BIN_DEBUG_DIR_86=bin$(PATH_SEP)Debug$(PATH_SEP)x86
BIN_RELEASE_DIR_86=bin$(PATH_SEP)Release$(PATH_SEP)x86
OBJ_DEBUG_DIR_86=obj$(PATH_SEP)Debug$(PATH_SEP)x86
OBJ_RELEASE_DIR_86=obj$(PATH_SEP)Release$(PATH_SEP)x86

BIN_DEBUG_DIR_64_MOVE=bin$(MOVE_PATH_SEP)Debug$(MOVE_PATH_SEP)x64
BIN_RELEASE_DIR_64_MOVE=bin$(MOVE_PATH_SEP)Release$(MOVE_PATH_SEP)x64
OBJ_DEBUG_DIR_64_MOVE=obj$(MOVE_PATH_SEP)Debug$(MOVE_PATH_SEP)x64
OBJ_RELEASE_DIR_64_MOVE=obj$(MOVE_PATH_SEP)Release$(MOVE_PATH_SEP)x64

BIN_DEBUG_DIR_86_MOVE=bin$(MOVE_PATH_SEP)Debug$(MOVE_PATH_SEP)x86
BIN_RELEASE_DIR_86_MOVE=bin$(MOVE_PATH_SEP)Release$(MOVE_PATH_SEP)x86
OBJ_DEBUG_DIR_86_MOVE=obj$(MOVE_PATH_SEP)Debug$(MOVE_PATH_SEP)x86
OBJ_RELEASE_DIR_86_MOVE=obj$(MOVE_PATH_SEP)Release$(MOVE_PATH_SEP)x86

ifeq ($(PROCESSOR_ARCHITECTURE),AMD64)

CFLAGS+=-m64 -march=native
ASFLAGS+=--64
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
ENTRY_POINT_PARAM=-e ENTRYPOINT
else
ENTRY_POINT_PARAM=
endif
LDFLAGS+=-m i386pep
GORCFLAGS+=/machine X64
BIN_DEBUG_DIR=$(BIN_DEBUG_DIR_64)
BIN_RELEASE_DIR=$(BIN_RELEASE_DIR_64)
OBJ_DEBUG_DIR=$(OBJ_DEBUG_DIR_64)
OBJ_RELEASE_DIR=$(OBJ_RELEASE_DIR_64)
BIN_DEBUG_DIR_MOVE=$(BIN_DEBUG_DIR_64)
BIN_RELEASE_DIR_MOVE=$(BIN_RELEASE_DIR_64)
OBJ_DEBUG_DIR_MOVE=$(OBJ_DEBUG_DIR_64)
OBJ_RELEASE_DIR_MOVE=$(OBJ_RELEASE_DIR_64)

else

CFLAGS+=-m32 -march=native
ASFLAGS+=--32
ifeq ($(WITHOUT_RUNTIME_FLAG),true)
ENTRY_POINT_PARAM=-e _ENTRYPOINT@0
else
ENTRY_POINT_PARAM=
endif
LDFLAGS+=-m i386pe --large-address-aware
GORCFLAGS+=/nw
BIN_DEBUG_DIR=$(BIN_DEBUG_DIR_86)
BIN_RELEASE_DIR=$(BIN_RELEASE_DIR_86)
OBJ_DEBUG_DIR=$(OBJ_DEBUG_DIR_86)
OBJ_RELEASE_DIR=$(OBJ_RELEASE_DIR_86)
BIN_DEBUG_DIR_MOVE=$(BIN_DEBUG_DIR_86)
BIN_RELEASE_DIR_MOVE=$(BIN_RELEASE_DIR_86)
OBJ_DEBUG_DIR_MOVE=$(OBJ_DEBUG_DIR_86)
OBJ_RELEASE_DIR_MOVE=$(OBJ_RELEASE_DIR_86)

endif

FBC ?= fbc.exe
FBCFLAGS+=-i src -r -O 0 -s console
FBCFLAGS_DEBUG+=-g -i src -r -O 0 -s console

CC ?= gcc.exe
EXTRA_CFLAGS+=-S
CFLAGS+=-Wall -Werror -Wno-main -Wno-unused-label -Wno-unused-function -Wno-unused-variable -Werror-implicit-function-declaration
CFLAGS_DEBUG+=-g
# CFLAGS+= ${EXTRA_CFLAGS} -I. -Isubdir
# ${CC} ${EXTRA_CFLAGS} ${CPPFLAGS} ${CFLAGS} -o $@ $< ${LDADD}

AS ?= as.exe
ASFLAGS+=--strip-local-absolute
ASFLAGS_DEBUG+=
# $(AS) $(ASFLAGS)

AR ?= ar.exe
# ARFLAGS

GORC ?= GoRC.exe
GORCFLAGS+=/d FROM_MAKEFILE /ni

LD ?= ld.exe
# LDFLAGS
# LDLIBS
# LD_DEBUG

# OBJECTS
# OBJECTS_DIR

LDFLAGS+=-subsystem console $(ENTRY_POINT_PARAM) --stack 1048576,1048576 --no-seh --nxcompat -L "$(LIB_DIR)"
# --print-gc-sections

OUTPUT_FILE_NAME_CONSOLE=Station922$(FILE_SUFFIX_CONSOLE).exe

OBJECTFILES_GUIDS_RELEASE=$(OBJ_RELEASE_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX_BASE).o
OBJECTFILES_GUIDS_DEBUG=  $(OBJ_DEBUG_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX_BASE).o

OBJECTFILES_RELEASE_CONSOLE_OBJECTS_COM=$(OBJ_RELEASE_DIR)$(PATH_SEP)AcceptConnectionAsyncTask$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ArrayStringWriter$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)AsyncResult$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ClientRequest$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ClientUri$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)CreateInstance$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)FileBuffer$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HeapBSTR$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HeapMemoryAllocator$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpGetProcessor$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpOptionsProcessor$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpProcessorCollection$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpReader$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpTraceProcessor$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)HttpWriter$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)IniConfiguration$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)MemoryBuffer$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)NetworkStream$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ReadRequestAsyncTask$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ServerResponse$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)TcpListener$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)ThreadPool$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WebServer$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WebSite$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WebSiteCollection$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WriteErrorAsyncTask$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WriteResponseAsyncTask$(FILE_SUFFIX_CONSOLE).o 
OBJECTFILES_DEBUG_CONSOLE_OBJECTS_COM=  $(OBJ_DEBUG_DIR)$(PATH_SEP)AcceptConnectionAsyncTask$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ArrayStringWriter$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)AsyncResult$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientRequest$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientUri$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)CreateInstance$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)FileBuffer$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Guids$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HeapBSTR$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HeapMemoryAllocator$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpGetProcessor$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpOptionsProcessor$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpProcessorCollection$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpReader$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpTraceProcessor$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)HttpWriter$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)IniConfiguration$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)MemoryBuffer$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)NetworkStream$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ReadRequestAsyncTask$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ServerResponse$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)TcpListener$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)ThreadPool$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebServer$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebSite$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebSiteCollection$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WriteErrorAsyncTask$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WriteResponseAsyncTask$(FILE_SUFFIX_CONSOLE).o   

OBJECTFILES_RELEASE_CONSOLE_MODULES=$(OBJ_RELEASE_DIR)$(PATH_SEP)ClientBuffer$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Station922$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Http$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Logger$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Mime$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)Network$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WebUtils$(FILE_SUFFIX_CONSOLE).o 
OBJECTFILES_DEBUG_CONSOLE_MODULES=  $(OBJ_DEBUG_DIR)$(PATH_SEP)ClientBuffer$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Station922$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Http$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Logger$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Mime$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)Network$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WebUtils$(FILE_SUFFIX_CONSOLE).o   

OBJECTFILES_RELEASE_CONSOLE_RESOURCES=$(OBJ_RELEASE_DIR)$(PATH_SEP)Resources$(FILE_SUFFIX_CONSOLE).obj
OBJECTFILES_DEBUG_CONSOLE_RESOURCES=  $(OBJ_DEBUG_DIR)$(PATH_SEP)Resources$(FILE_SUFFIX_CONSOLE).obj

OBJECTFILES_RELEASE_CONSOLE_BASE=$(OBJECTFILES_RELEASE_CONSOLE_OBJECTS_COM) $(OBJECTFILES_RELEASE_CONSOLE_MODULES) $(OBJECTFILES_RELEASE_CONSOLE_RESOURCES)
OBJECTFILES_DEBUG_CONSOLE_BASE=  $(OBJECTFILES_DEBUG_CONSOLE_OBJECTS_COM)   $(OBJECTFILES_DEBUG_CONSOLE_MODULES)   $(OBJECTFILES_DEBUG_CONSOLE_RESOURCES)

OBJECTFILES_RELEASE_CONSOLE=$(OBJECTFILES_RELEASE_CONSOLE_BASE) $(OBJ_RELEASE_DIR)$(PATH_SEP)ConsoleMain$(FILE_SUFFIX_CONSOLE).o $(OBJ_RELEASE_DIR)$(PATH_SEP)WindowsServiceMain$(FILE_SUFFIX_CONSOLE).o
OBJECTFILES_DEBUG_CONSOLE=  $(OBJECTFILES_DEBUG_CONSOLE_BASE)   $(OBJ_DEBUG_DIR)$(PATH_SEP)ConsoleMain$(FILE_SUFFIX_CONSOLE).o   $(OBJ_DEBUG_DIR)$(PATH_SEP)WindowsServiceMain$(FILE_SUFFIX_CONSOLE).o  


all: release debug

release: CFLAGS+=$(CFLAGS_RELEASE)
release: ASFLAGS+=--strip-local-absolute
release: LDFLAGS+=-s --gc-sections -L "$(OBJ_RELEASE_DIR)"
release: $(BIN_RELEASE_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME_CONSOLE)

debug: CFLAGS+=$(CFLAGS_DEBUG)
debug: LDFLAGS+=-L "$(OBJ_DEBUG_DIR)"
debug: LDLIBS+=$(LDLIBS_DEBUG)
debug: GORCFLAGS+=/d DEBUG
debug: $(BIN_DEBUG_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME_CONSOLE)

clean:
	echo $(DELETE_COMMAND) %AllFileWithExtensionC% %AllFileWithExtensionAsm% %AllObjectFiles%

include dependencies.mk


$(BIN_RELEASE_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME_CONSOLE): $(OBJECTFILES_RELEASE_CONSOLE)
	$(LD) $(LDFLAGS) $^ $(LDLIBS) -o $@

$(BIN_DEBUG_DIR)$(PATH_SEP)$(OUTPUT_FILE_NAME_CONSOLE):   $(OBJECTFILES_DEBUG_CONSOLE)
	$(LD) $(LDFLAGS) $^ $(LDLIBS) -o $@

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).o: $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).asm
	$(AS) $(ASFLAGS) -o $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).o: $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).asm
	$(AS) $(ASFLAGS_DEBUG) -o $@ $<

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).asm: $(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).c
	$(CC) $(EXTRA_CFLAGS) $(CFLAGS) -o $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).asm: $(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).c
	$(CC) $(EXTRA_CFLAGS) $(CFLAGS_DEBUG) -o $@ $<

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).c: src$(PATH_SEP)%.bas
	$(FBC) $(FBCFLAGS) $<
	$(MOVE_COMMAND) src$(MOVE_PATH_SEP)$*.c $@

$(OBJ_DEBUG_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).c: src$(PATH_SEP)%.bas
	$(FBC) $(FBCFLAGS_DEBUG) $<
	$(MOVE_COMMAND) src$(MOVE_PATH_SEP)$*.c $@

$(OBJ_RELEASE_DIR)$(PATH_SEP)%$(FILE_SUFFIX_CONSOLE).obj: src$(PATH_SEP)%.RC
	$(GORC) $(GORCFLAGS) /o /fo $@ $<

$(OBJ_DEBUG_DIR)$(PATH_SEP)Resources$(FILE_SUFFIX_CONSOLE).obj:
	$(GORC) $(GORCFLAGS) /o /fo $@ $<
